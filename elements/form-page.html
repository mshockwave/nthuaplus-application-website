<script src="../bower_components/webcomponentsjs/webcomponents.min.js"></script>
<link rel="import" href="base-elements.html">
<link rel="import" href="../bower_components/iron-form/iron-form.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../bower_components/paper-radio-button/paper-radio-button.html">
<link rel="import" href="../bower_components/paper-radio-group/paper-radio-group.html">
<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/gold-date-input/date-input.html">
<link rel="import" href="../bower_components/gold-phone-input/gold-phone-input.html">
<link rel="import" href="../bower_components/gold-email-input/gold-email-input.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/paper-tooltip/paper-tooltip.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/file-upload/file-upload.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">

<link rel="import" href="language-ability-dialog.html">
<link rel="import" href="classes-history-dialog.html">

<dom-module id="form-page">
    <template>
        <style>
            .main-content {
                padding: 10px;
            }

            paper-input.expand{
                width: 50%;
            }
            paper-textarea.expand {
                width: 60%;
            }
            gold-email-input.expand {
                width: 60%;
            }
            gold-phone-input.expand {
                width: 50%;
            }
            .expand {
                width: 90%;
            }

            #fab-group {
                position: fixed;
                right: 30px;
                bottom: 30px;
            }
            #fab-group paper-fab {
                margin: 10px;
            }
            #butDrafts {
                --paper-fab-background: #009688;
            }
            #butSubmit {
                --paper-fab-background: #FF5722;
            }

            paper-tooltip {
                --paper-tooltip-background: black;
                --paper-tooltip-opacity: 1.0;
                --paper-tooltip: {
                    font-size: 14px;
                };
            }

            paper-button {
                background: var(--button-gray-background);
            }

            .hidden {
                display: none;
            }

            paper-toast {
                right: 30%;
                left: 20%;
                bottom: 20px;

                font-size: 20px;

                --paper-toast-background-color: #689F38;
                --paper-toast-color: white;
            }
            paper-toast.error {
                --paper-toast-background-color: red;
                --paper-toast-color: white;
            }
            paper-toast.invalid {
                --paper-toast-background-color: #E91E63;
                --paper-toast-color: white;
            }
        </style>

        <div id="fab-group" class="layout vertical center around-justified">
            <!--
            <paper-fab id="butDrafts" icon="drafts"></paper-fab>
            <paper-tooltip for="butDrafts" position="left">儲存草稿</paper-tooltip>
            -->

            <paper-fab id="butSubmit" icon="send" on-click="_handleFormSubmit"></paper-fab>
            <paper-tooltip for="butSubmit" position="left">提交</paper-tooltip>

            <paper-toast id="toastSuccess" text="提交成功!"
                         auto-fit-on-attach></paper-toast>

            <paper-toast id="toastError" class="error" text="提交失敗"
                         auto-fit-on-attach></paper-toast>

            <paper-toast id="toastInvalid" class="invalid" text="表單格式錯誤，請再檢查一次"
                         auto-fit-on-attach></paper-toast>
        </div>

        <div class="layout horizontal start center-justified main-content">
            <div id="formContainer" class="layout vertical start">
                <!-- iron-form hasn't support multipart/form-data!-->
                <form id="appForm" is="iron-form"
                      method="post" action="/api/form/submit"
                      on-iron-form-response="_onFormSuccess"
                      on-iron-form-error="_onFormFailed">
                    <h3>申請主題</h3>
                    <paper-radio-group required>
                        <paper-radio-button name="topic1">電腦視覺三維模型重建與辨識技術</paper-radio-button><br />
                        <paper-radio-button name="topic2">具穩健機率運算能力之突波式神經網路系統研發</paper-radio-button><br />
                        <paper-radio-button name="topic3">虛擬載具在高效能異質環境研究</paper-radio-button><br />
                    </paper-radio-group>
                    <br/>

                    <paper-input label="姓名" name="name" class="expand"
                                 required auto-validate error-message="錯誤"></paper-input><br />
                    <paper-input label="學校" name="school" class="expand"
                                 required auto-validate error-message="錯誤"></paper-input><br />
                    <paper-input label="系所" name="department" class="expand"
                                 required auto-validate error-message="錯誤"></paper-input><br />

                    <div class="layout horizontal center ">
                        <paper-dropdown-menu name="gradeType" label="年級種類" required style="margin-right: 5px;">
                            <paper-listbox class="dropdown-content">
                                <paper-item>學士班</paper-item>
                                <paper-item>碩士班</paper-item>
                                <paper-item>博士班</paper-item>
                            </paper-listbox>
                        </paper-dropdown-menu>
                        <paper-input label="年級" name="schoolGrade"
                                     required auto-validate error-message="錯誤" type="number"></paper-input><br />
                    </div>

                    <br/>
                    <div class="layout horizontal center ">
                        <span>生日</span>
                        <date-input required name="birthday"></date-input>
                    </div><br/>

                    <paper-input label="身分證字號" name="formalId" class="expand"
                                 required auto-validate error-message="錯誤"></paper-input><br />
                    <gold-phone-input label="聯絡電話" name="phoneNumber" class="expand"
                                      country-code="886"
                                      phone-number-pattern="XXXX-XXX-XXX"
                                      required auto-validate error-message="錯誤"></gold-phone-input><br/>
                    <gold-email-input label="Email" name="email" class="expand"
                                      required auto-validate error-message="錯誤"></gold-email-input><br/>

                    <paper-textarea name="address" label="通訊地址" class="expand" multiple
                                    required auto-validate error-message="必填"></paper-textarea><br/>

                    <paper-textarea name="researchArea" label="研究領域" class="expand" multiple rows="3"
                                    required auto-validate error-message="必填"></paper-textarea><br/>

                    <paper-input label="指導老師" name="teacher" class="expand"
                                 required auto-validate error-message="必填"></paper-input><br />

                    <br/>
                    <classes-history-dialog name="classHistory"></classes-history-dialog>
                    <paper-button on-click="_showClassDialog" raised >編輯預修課程</paper-button><br/>

                    <paper-textarea name="relatedSkills" label="相關專業能力" class="expand" multiple rows="3"
                                    required auto-validate error-message="必填"></paper-textarea><br/>

                    <br/>
                    <div class="layout horizontal center around-justified expand">
                        <span>成績排名</span>
                        <paper-input name="average" label="總平均" style="margin: 0 20px;"
                                     required auto-validate error-message="錯誤" type="text"></paper-input>
                        <paper-input name="ranking" label="年級排名"
                                     required auto-validate error-message="錯誤" type="text"></paper-input>
                    </div><br/>

                    <br/>
                    <language-ability-dialog name="langAbilities"></language-ability-dialog>
                    <paper-button on-click="_showLanguageDialog" raised >編輯語言能力</paper-button><br/>

                    <paper-input name="researchPlan" class="hidden"
                                 required value="{{filePlan}}"></paper-input>

                    <paper-input name="recommendationLetters" class="hidden"
                                 required value="{{fileLetters}}"></paper-input>

                    <paper-input name="transcript" class="hidden"
                                 required value="{{fileTranscript}}"></paper-input>

                    <paper-input name="others" class="hidden"
                                 value="{{fileOthers}}"></paper-input>

                    <!-- <input type="submit"> -->
                </form>

                <br/><br/>
                <file-upload target="/api/form/upload"
                             raised
                             data-name="researchPlan"
                             on-success="_handleFileUpload"
                             on-error="_handleFileUploadError"
                             on-before-upload="_handleFileBeforeUpload">研究規劃書上傳</file-upload>

                <file-upload target="/api/form/upload"
                             raised
                             data-name="recommendationLetters"
                             on-success="_handleFileUpload"
                             on-error="_handleFileUploadError"
                             on-before-upload="_handleFileBeforeUpload">推薦函（至少兩封，請合併成一份）上傳</file-upload>

                <file-upload target="/api/form/upload"
                             raised
                             data-name="transcript"
                             on-success="_handleFileUpload"
                             on-error="_handleFileUploadError"
                             on-before-upload="_handleFileBeforeUpload">成績單上傳</file-upload>

                <file-upload target="/api/form/upload"
                             raised
                             data-name="others"
                             on-success="_handleFileUpload"
                             on-error="_handleFileUploadError"
                             on-before-upload="_handleFileBeforeUpload">其他補充資料上傳</file-upload>
            </div>
        </div>
    </template>

    <script>
        Polymer({
            is: 'form-page',

            _showLanguageDialog: function(){
                document.querySelector('language-ability-dialog').show();
            },
            _showClassDialog: function(){
                document.querySelector('classes-history-dialog').show();
            },

            _handleFileUpload: function(e){
                //console.log('Success');
                //console.log(e);

                //console.log(e.target.getAttribute('data-name'));
                //console.log(JSON.parse(e.detail.xhr.response));
                var objName = JSON.parse(e.detail.xhr.response);
                var name = e.target.getAttribute('data-name');
                switch (name) {
                    case "researchPlan":
                        this.set('filePlan', objName.Description);
                        break;

                    case "recommendationLetters":
                        this.set('fileLetters', objName.Description);
                        break;

                    case "transcript":
                        this.set('fileTranscript', objName.Description);
                        break;

                    case "others":
                        this.set('fileOthers', objName.Description);
                        break;
                }
            },
            _handleFileUploadError: function(e){
                console.log('Failed');
                console.log(e);
            },
            _handleFileBeforeUpload: function(e){
                //console.log('Before upload');
                var f = e.target;
                if(f.files.length > 1) {
                    f.set('files', [f.files[f.files.length - 1]]);
                }
            },

            _handleFormSubmit: function(){
                var form = this.$.appForm;

                if(form.validate()){
                    form.submit();
                }else{
                    this.$.toastInvalid.open();
                }
            },
            _onFormSuccess: function(){
                this.$.toastSuccess.open();
            },
            _onFormFailed: function(){
                this.$.toastError.open();
            }
        });
    </script>
</dom-module>